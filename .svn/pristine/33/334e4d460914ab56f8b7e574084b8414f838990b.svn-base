{extends file="layout/base.tpl"}
{block name="body"} 

<div class="row">
    <div class="col-md-12 col-md-offset-1">

        <h2 class="title text-center">
            <i class="material-icons">receipt</i>
            #{$ticket_arr['name']}
        </h2>
        <br>

        <div class="default-tab">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#home"><i class="la la-home me-2"></i> {lang('text_information')}</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#profile"><i class="la la-user me-2"></i> {lang('text_reply')}</a>
                </li>
            </ul>
        </div>
        <div class="tab-content">
            {include file="{log_user_type()}/support/ticket_details_tabs/info.tpl"}
            {include file="{log_user_type()}/support/ticket_details_tabs/reply.tpl"}
        </div>
    </div>
</div>
{/block}

{block name="footer"} 
<script src="{assets_url('support/js/bootstrap-notify.js')}"></script>

<script type="text/javascript">

 $(document).ready(function(){

  $("#media").change(function()
  {
    var s_id=$(this).val();
    var ticket_id=$(this).attr('title');


    $.ajax({
        type: 'POST',
        url: '{base_url()}admin/support/changeStatus', 
        data : { status:s_id,ticket_id:ticket_id }
    }).then(function (data) { 
        location.reload();

    });
});
}); 
</script>

<script type="text/javascript">
    $(document).ready(function() {
        setTimeout(function() {
            $('.card.wizard-card').addClass('active');
        }, 600);
    });
</script>

<script type="text/javascript">

    (function($){   
        $.fn.loaddata = function(options) { 
            var settings = $.extend({ 
                loading_gif_url : '{assets_url()}images/gif/loader-signature.gif',
                end_record_text : 'No more records found!',
                loadbutton_text : 'Load More Contents!',
                data_url        : '{base_url()}admin/support/getTicketActivityRequest',  
                start_page      : 0 
            }, options);

            var el = this;  
            loading  = false; 
            end_record = false;     

            var load_more_btn = $('<button/>').text(settings.loadbutton_text).addClass('btn btn-warning pull-right').click(function(e){ 
                contents(el, this, settings);
            });

            contents(el, load_more_btn, settings); 
        }; 

        function contents(el, load_btn,  settings){
            var load_img = $('<img/>').attr('src',settings.loading_gif_url).addClass('loading-image');

            var record_end_txt = $('<div/>').text(settings.end_record_text).addClass('text-center'); 

            if(loading == false && end_record == false){
                loading = true; 
                el.append(load_img);

                if(load_btn.type === 'submit' || load_btn.type === 'click'){
                    load_btn.remove();
                }

                $.post( settings.data_url, { 'page': settings.start_page, 'ticket_id': '{$ticket_id}' }, function(data){
                    data =  jQuery.parseJSON(data);
                    if(data.error){
                    }else{                        
                        if(data.message.trim().length == 0){ 
                            el.append(record_end_txt);
                            load_img.remove();
                            load_btn.remove();
                            end_record = true; 
                            return;
                        }
                        loading = false;
                        load_img.remove();
                        el.append(data.message).append(load_btn);
                        settings.start_page = parseInt(settings.start_page) + 5;
                    }
                })
            }
        }
    })(jQuery);

    $("#ticket_actity").loaddata();

    $('#btn-reply').on('click', function(){
        var replyurl = '{base_url()}admin/support/replyTicket';
        var ticket_id = '{$ticket_id}';
        message = $('#reply_msg').val();


        $.post( replyurl, { 'ticket_id': ticket_id, 'message': message }, function(response){
            response =  jQuery.parseJSON(response);
            type = ['', 'info', 'success', 'warning', 'danger', 'rose', 'primary'];
            if(response.error){
                color = 4;
            }else{
                color = 2;
                html = '<li><div class="timeline-badge info"><i class="material-icons">history</i></div><div class="timeline-panel"><div class="timeline-heading"><span class="label label-info">'+ response.user_name + '</span></div><div class="timeline-body"><p>'+ message + '.</p></div><h6><i class="ti-time"></i> Now</h6></div></li>'
                $( "#ticket_actity" ).prepend(html);
            }

            $.notify({
                icon: "notifications",
                message: response.message

            }, {
                type: type[color],
                timer: 3000,
                placement: {
                    from: 'top',
                    align: 'right'
                }
            });

        });
        // location.reload();
         $('#reply_msg').val('');
    });
</script>

{/block}
