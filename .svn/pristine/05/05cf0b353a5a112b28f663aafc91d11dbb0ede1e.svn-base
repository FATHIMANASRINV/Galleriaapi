{extends file="layout/base.tpl"}

{block name="header"} 

<link href="{assets_url()}plugins/DataTables/datatables.min.css" rel="stylesheet" />
<link href="{assets_url()}plugins/DataTables/DataTables-1.12.1/css/buttons.dataTables.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="{assets_url('plugins/sweetalert/lib/sweet-alert.css')}">
<link href="{assets_url()}plugins/select2/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="{assets_url('plugins/datepicker/css/metallic/zebra_datepicker.min.css')}">

{/block} 

{block name="body"} 

<div style="display:none;">
    <span id="base_url">{base_url()}</span>
    <span id="text_are_you_sure">{lang('text_are_you_sure')}</span>
    <span id="text_you_want_delete">{lang('text_you_want_delete')}</span>
    <span id="text_yes_delete">{lang('text_yes_delete')}</span>
    <span id="text_no_cancel_please">{lang('text_no_cancel_please')}</span>
    <span id="text_rejected">{lang('text_rejected')}</span>
    <span id="text_cancelled">{lang('text_cancelled')}</span>
    <span id="text_news_safe">{lang('text_news_safe')}</span>
    <span id="text_yes_approve_it">{lang('text_yes_approve_it')}</span>
    <span id="text_you_want_approve">{lang('text_you_want_approve')}</span>  
</div>

<div class="row "> 
    <div class="col-sm-12"> 
        <div class="card">

            <div class="card-body"> 
                {form_open('','')}
                <div class="form-body">
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label for="user_name" class="control-label">{lang('user_name')}</label>
                                <select name="user_name" id="user_name" class="form-control user_name_ajax" {set_select('user_name', set_value('user_name'))}>
                                    {if $post_arr['user_name']}
                                    <option value="{$post_arr['user_name']}" selected>{$post_arr['user_name']}</option>
                                    {/if}
                                </select>
                                
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">

                                <label for="from_date">{lang('from_date')}</label>
                                <div class="col-10">
                                    <input class="form-control" type="date"  id="from_date" name="from_date" value="{$post_arr['from_date']}">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">

                                <label for="end_date">{lang('end_date')}</label>
                                <div class="col-10">
                                    <input class="form-control" type="date" id="end_date" name="end_date" value="{$post_arr['end_date']}">
                                </div>
                            </div>
                        </div>



                        <div class="col-sm-4"> <br>
                            <button type="submit" class="btn btn-primary" name="submit" value="search">
                                <i class="fa fa-filter"></i> {lang('filter')}
                            </button>
                            <button type="submit" class="btn btn-warning mr-1" name="submit" value="reset">
                                <i class="fas fa-retweet"></i>  {lang('reset')}
                            </button> 
                        </div>
                    </div>
                </div>
                {form_close()}
            </div>
            
        </div> 
    </div> 
</div><br>

<div class="row "> 
	<div class="col-sm-12"> 
		<div class="card"> 

			<div class="card-header">
				<h5>{$title}</h5>
				
			</div>

			<div class="card-content">
				<div class="card-body">  
					
					<div class="table-responsive">
						<table class="table color-table primary-table" id="dataTable">
							<thead >
								<tr>
									<th>#</th>
									<th>{lang('user_name')}</th>
									<th>{lang('requested_amount')}</th>
                                    <th>{lang('release_amount')}</th>
                                    <th>{lang('requested_date')}</th>
                                    <th>{lang('by_using')}</th>   
                                    <th>{lang('action')}</th>  
                                    
                                </tr>
                            </thead>
                        </table>

                    </div>
                </div>
            </div>
        </div> 
    </div> 
</div>


{/block}

{block name="footer"}
<script src="{assets_url()}plugins/DataTables/datatables.min.js"></script>
<script src="{assets_url('plugins/datepicker/zebra_datepicker.min.js')}"></script>
<script src="{assets_url('plugins/sweetalert/lib/sweet-alert.min.js')}"></script>
<script src="{assets_url()}plugins/select2/select2.min.js"></script>

<script>

   $('#from_date').Zebra_DatePicker({
        pair: $('.to_date')
    });
    $('#end_date').Zebra_DatePicker();


    function delete_req(id)
    {
        swal({
            title: $("#text_are_you_sure").html(),
            text: $("#text_you_want_delete").html(),
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: $("#text_yes_delete").html(),
            cancelButtonText: $("#text_no_cancel_please").html(),
            closeOnConfirm: false,
            closeOnCancel: false
        },
        function (isConfirm) {
            if (isConfirm) {
                document.location.href =  "{base_url()}admin/business/payout_release/delete/"+id; 
            } else {
                swal($("#text_cancelled").html(),$("#text_req_safe").html(), "error");
            }
        });

    }
    function approve_req(id)
    {
        swal({
            title: $("#text_are_you_sure").html(),
            text: $("#text_you_want_approve").html(),
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: $("#text_yes_approve_it").html(),
            cancelButtonText: $("#text_no_cancel_please").html(),
            closeOnConfirm: false,
            closeOnCancel: false
        },
        function (isConfirm) {
            if (isConfirm) {
              document.location.href = "{base_url()}admin/business/payout_release/approve/"+id; 

          } else {
            swal($("#text_cancelled").html(),$("#text_req_safe").html(), "error");
        }
    });

    }
    $(document).ready( function () {

      $('.user_name_ajax').select2({
        placeholder:'{lang('select_a_user')}',
        ajax: {
            url: '{base_url()}admin/autocomplete/getUser_ajax',
            type:'post',
            dataType: 'json',
            delay: 250,
            processResults: function (data) { 
                return {
                    results: data
                };

            },
            cache: true
        }

    });

  });

    $(document).ready(function(){  

        var datatable = $('#dataTable').DataTable({

            'processing': true,
            'serverSide': true,
            "autoWidth": false,
            'serverMethod': 'post', 
            "pagingType": "full_numbers",
            "pageLength": 10,
            "sortable": true,

            "aaSorting": [],
            "order": [],
            "aoColumnDefs": [
            { "bSortable": false, "aTargets": [ 0, 1, 2, 3, 4,5,6] },  
            ],


            "columnDefs": [{
                "targets": 'no-sort',
                "orderable": false,
                "order": [],
            }],

            'ajax': {
                'url':'{base_url(log_user_type())}/business/get_payout_requests_ajax',
                'type': "POST", 
                'data' : { 
                    'user_name' : '{$post_arr['user_name']}',
                    'from_date' : '{$post_arr['from_date']}',
                    'end_date' : '{$post_arr['end_date']}',
                }

            },

            'columns': [

            { data: 'index'},

            { data: 'user_name'},
            { data: 'amount'},
            { data: 'release_amount'},
            { data: 'requested_date'},
            { data: 'by_using'},
            { data: 'req_id', mRender: function(data, type, row) {

                var  link= ''


                link +="<a href='#' title='{lang('text_approve')}' data-placement='top' data-id='"+row.req_id+"' class='approve-payout'><i class='fas fa-check text-success'></i></a>";
                link +="<a href='#' title='{lang('text_delete')}' data-placement='top' data-id='"+row.req_id+"' class='reject-payout'><i class='fas fa-trash text-danger'></i></a>";


                return link;
            }}, 
            ],
            success: function(response) { 
            } 
        }); 


        $(document).on("click", "body #dataTable tbody .approve-payout" , function() {
            var id= $(this).attr("data-id");
            if(confirm($("#text_you_want_approve").html(),)){
                $.ajax({
                 type: "POST",
                 url: '{base_url("admin/business/payout_approve_ajax")}', 
                 data: { id: id},
                 dataType: "json",  
                 cache:false,
                 success: 
                 function(data){
                    datatable.ajax.reload(null, false );  
                }
            });
            }else{
                return false;

            }


        });

        $(document).on("click", "body #dataTable tbody .reject-payout" , function() {
            var id= $(this).attr("data-id");
            if(confirm($("#text_you_want_delete").html(),)){
              $.ajax({
                 type: "POST",
                 url: '{base_url("admin/business/payout_reject_ajax")}', 
                 data: { id: id},
                 dataType: "json",  
                 cache:false,
                 success: 
                 function(response, status){ 
                    datatable.ajax.reload(null, false ); 
                }
            });
          }
          else{
              return false;
          }
      });
    });
</script>
<script type="text/javascript">
  $(document).ready( function () {

      $('#dataTable').DataTable();
  } );
  
</script>
{/block}